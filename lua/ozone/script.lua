local buffer = require("string.buffer")

---@class ozone.Script
---@field default_rtdirs ozone.Script.RuntimeDir[]
---@field rtdirs ozone.Script.RuntimeDir[]
---@field after_rtdirs ozone.Script.RuntimeDir[]
local Script = {}
---@private
Script.__index = Script

---@class ozone.Script.RuntimeDir
---@field path string

---@return self
function Script.new()
    return setmetatable({
        default_rtdirs = {},
        rtdirs = {},
        after_rtdirs = {},
    }, Script)
end

---@return string
function Script:tostring()
    local buf = buffer.new():put([[
-- Code generated by nvim-ozone
-- vim:ft=lua:readonly:nowrap
]])
    local rtp = {} ---@type string[]
    for _, rtdir in ipairs(self.rtdirs) do
        table.insert(rtp, rtdir.path)
    end
    for _, rtdir in ipairs(self.default_rtdirs) do
        table.insert(rtp, rtdir.path)
    end
    for _, rtdir in ipairs(self.after_rtdirs) do
        table.insert(rtp, rtdir.path)
    end
    buf:putf('vim.api.nvim_set_option_value("runtimepath", %q, {})\n', table.concat(rtp, ","))
    buf:put([[
vim.opt.loadplugins = false
vim.cmd("runtime! plugin/**/*.{vim,lua}")
vim.cmd("augroup filetypedetect")
vim.cmd("runtime! ftdetect/*.{vim,lua}")
vim.cmd("augroup END")
]])

    return buf:tostring()
end

return Script
